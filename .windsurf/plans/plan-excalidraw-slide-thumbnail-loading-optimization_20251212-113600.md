# 计划：Excalidraw 幻灯片缩略图加载优化（跨 Tab 缓存 + 按需优先生成）

## 任务背景
- 当前“幻灯片”标签页的 slide 列表缩略图由 `PresentationMenu.tsx` 在挂载后通过 `exportToCanvas()` 逐张导出生成，并使用 `canvas.toDataURL()` 转成 dataURL。
- 现状问题：slide 数量增多后，点击“幻灯片”标签会出现较长时间全局 loading；并且只要切换到其他 tab 再切回来，仍会再次出现长时间 loading。
- 根因初判：
  - Radix Tabs 的 `Tabs.Content` 默认会在切换 tab 时卸载内容，导致 `PresentationMenu` 被卸载重建；而当前 `thumbnailCache` 是组件内 `useRef`，因此缓存随卸载丢失。
  - 重新进入 tab 会串行对所有 frame 调用 `exportToCanvas` 全量生成缩略图，导致主线程长任务与等待。

## 目标与非目标
### 目标
- 切换到“幻灯片”Tab：不再出现长时间全局 loading（列表立即可交互）。
- 点击画布某个 frame 后：对应 slide 滚动到可视区时，缩略图要立即出现。

### 非目标（本轮不做）
- 列表虚拟化（如 react-window）。
- 将缩略图持久化到 IndexedDB / 服务端。

## 需求与关键场景
- 场景 A：用户频繁在“属性/动画/幻灯片”等 tab 之间切换。
  - 预期：切到“幻灯片”后列表立刻出现；缩略图已有则直接显示，没有则逐步补齐。
- 场景 B：用户在画布中点击某个 frame（可能对应列表末尾 slide），列表自动滚动定位。
  - 预期：滚动到目标 slide 时缩略图已显示；如果此前未生成，需高优先级立即生成并尽快渲染。

## 技术方案草案
### 方案 1：跨 Tab 缓存（P0）
- 将缩略图缓存从 `PresentationMenu` 组件生命周期中抽离（例如模块级 cache 或更上层 state/atom）。
- 目标：tab 切换导致组件卸载时，缓存不丢失；再次进入 tab 直接命中缓存，避免重复导出。

### 方案 2：按需优先生成（P0）
- 将“全量串行生成”改为“按需 + 优先级队列”：
  - 首次进入 tab：立即渲染列表（含占位/已有缓存）。
  - 缩略图生成分片执行，避免长时间阻塞。
  - 当 `activeSlideId`（或目标 frameId）变化时，将其加入最高优先级队列，确保滚动定位时缩略图能立即出现。
- 需要支持：
  - 去重：同一 frameId 不重复生成。
  - 过期取消：tab 快速切换或依赖变化时，旧任务不应回写覆盖。

### 方案 3：降低单张缩略图成本（P1，可选）
- 缩略图导出采用更小尺寸/缩放（通过 `exportToCanvas` 的 `createCanvas` 参数控制）。
- 输出格式可评估使用 `image/webp` 或 `image/jpeg`（减少体积与解码压力）。

## 验收标准
- 切换到“幻灯片”Tab：
  - 列表容器立即渲染，可滚动、可点击；不再出现长时间“正在加载缩略图...”阻塞交互。
  - 缩略图可允许分批出现，但首屏体验明显提升。
- 点击画布某个 frame 后：
  - slide 列表滚动定位到对应卡片时，该卡片缩略图应立即可见；若此前未生成，应触发高优先级生成并在极短时间内显示。
- 回归：
  - 拖拽调整 slide 顺序、保存顺序、开始播放等功能不受影响。

## 风险与未知问题
- Radix Tabs 的挂载策略与 sidebar 的生命周期可能导致状态频繁重建，需要确保缓存抽离后不会造成内存无限增长（必要时增加简单上限/淘汰策略）。
- `exportToCanvas` 导出成本与图片资源有关，需控制并发与分片粒度，避免主线程卡顿。
- “立即出现”的严格程度需要与实际场景匹配：若缩略图从未生成过，理论上仍需一次导出时间；需通过优先级与降成本策略尽可能缩短。
